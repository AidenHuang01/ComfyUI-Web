<!DOCTYPE html>
<html>
<head>
  <title>ComfyUI Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background-color: #f7f7f7;
      color: #333;
      box-sizing: border-box;
    }
    .container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
    }
    h2 {
      color: #111;
    }
    #prompt {
      width: 100%;
      height: 120px;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: vertical;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    #generate-btn, #save-btn {
      padding: 12px 20px;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #generate-btn {
      background-color: #007bff;
    }
    #generate-btn:disabled {
      background-color: #a0a0a0;
    }
    #save-btn {
      background-color: #28a745;
    }
    #generating-text {
      display: none;
      margin-top: 10px;
      color: #555;
      text-align: center;
    }
    .progress-container {
      width: 100%;
      margin: 20px 0;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background-color: #007bff;
      width: 0%;
      transition: width 0.3s ease-in-out;
    }
    .progress-text {
      margin-top: 5px;
      text-align: center;
    }
    #result {
      width: 100%;
      margin-top: 20px;
      border-radius: 8px;
    }
    #logs {
      display: none;
      height: 300px;
      width: 100%;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fff;
      margin-top: 20px;
      box-sizing: border-box;
      white-space: pre-wrap;
      word-wrap: break-word;
      border-radius: 8px;
      font-family: monospace;
    }

    /* Desktop styles */
    @media (min-width: 768px) {
      #generate-btn, #save-btn {
        width: auto;
        display: inline-block !important;
      }
      .button-group {
        display: flex;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ComfyUI Web HarunaAoba</h2>
    <p>Enter your prompt to generate an image.</p>
    <textarea id="prompt" placeholder="e.g., a beautiful landscape painting, trending on artstation"></textarea>
    <div class="button-group">
      <button id="generate-btn" onclick="generate()">Generate</button>
      <button id="save-btn" onclick="saveToDrive()" style="display: none;">Save to Google Drive</button>
    </div>
    <span id="generating-text">Generating, please wait...</span>
    
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text" id="progress-text">Progress: 0%</div>
    </div>
    
    <img id="result" alt="Generated Image">

    <h3 style="display: none;">Logs</h3>
    <pre id="logs"></pre>
  </div>

  <script>
    let ws = null;
    let promptId = null;

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(protocol + '//' + window.location.host + '/ws');
      
      ws.onopen = function() {
        console.log("WebSocket connected");
        document.getElementById("logs").textContent += "WebSocket connected\n";
      };

      ws.onmessage = function(event) {
        const logs = document.getElementById("logs");
        logs.textContent += event.data + "\n";
        logs.scrollTop = logs.scrollHeight;

        try {
          const message = JSON.parse(event.data);
          if (message.type === "progress") {
            const { value, max } = message.data;
            const percentage = Math.round((value / max) * 100);
            document.getElementById("progress-fill").style.width = `${percentage}%`;
            document.getElementById("progress-text").textContent = `Progress: ${percentage}%`;
          } else if (message.type === "executed" && message.data.prompt_id === promptId) {
            document.getElementById("progress-text").textContent = "Processing complete!";
          }
        } catch (e) {
          // Not a JSON message, just a log line.
        }
      };

      ws.onclose = function() {
        console.log("WebSocket closed, reconnecting...");
        document.getElementById("logs").textContent += "WebSocket closed, reconnecting...\n";
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = function(error) {
        console.error("WebSocket error:", error);
        document.getElementById("logs").textContent += "WebSocket error. See console for details.\n";
      };
    }

    async function saveToDrive() {
      if (!promptId) {
        alert("No image to save!");
        return;
      }
      const saveBtn = document.getElementById("save-btn");
      const originalBtnText = saveBtn.textContent;
      try {
        saveBtn.textContent = "Saving to Google Drive...";
        saveBtn.disabled = true;
        const res = await fetch(`/save_to_drive/${promptId}`, {
          method: "POST",
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        if (res.ok) {
          const data = await res.json();
          alert("Image saved to Google Drive! File ID: " + data.file_id);
        } else {
          const errorText = await res.text();
          alert("Failed to save to Google Drive: " + errorText);
        }
      } catch (e) {
        alert("Error saving to Google Drive: " + e.message);
      } finally {
        saveBtn.textContent = originalBtnText;
        saveBtn.disabled = false;
      }
    }

    async function generate() {
      const generateBtn = document.getElementById("generate-btn");
      const generatingText = document.getElementById("generating-text");
      
      try {
        generateBtn.disabled = true;
        generatingText.style.display = "block";

        document.getElementById("progress-fill").style.width = "0%";
        document.getElementById("progress-text").textContent = "Progress: 0%";
        document.getElementById("result").src = "";
        document.getElementById("result").style.display = "none";
        document.getElementById("save-btn").style.display = "none";
        document.getElementById("logs").textContent = "";

        const prompt = document.getElementById("prompt").value;
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        if (!res.ok) {
          const errorText = await res.text();
          alert(`Generation failed: ${errorText} (Status: ${res.status})`);
          return;
        }

        const data = await res.json();
        promptId = data.prompt_id;
        console.log("Prompt ID:", promptId);
        connectWebSocket();

        const imageContainer = document.getElementById("result");
        const saveBtn = document.getElementById("save-btn");

        // Poll for the image
        const pollImage = async (promptId, retries = 150, interval = 2000) => {
          for (let i = 0; i < retries; i++) {
            try {
              const imageRes = await fetch(`/get_image/${promptId}`);
              if (imageRes.ok) {
                const blob = await imageRes.blob();
                imageContainer.src = URL.createObjectURL(blob);
                imageContainer.style.display = "block";
                saveBtn.style.display = "inline-block";
                return; // Success
              }
            } catch (e) {
              console.error("Polling error:", e);
            }
            await new Promise(resolve => setTimeout(resolve, interval));
          }
          alert("Failed to retrieve image after multiple attempts.");
        };

        pollImage(promptId);

      } catch (e) {
        console.error("Generate error:", e);
        alert("Failed to generate image: " + e.message);
      } finally {
        generateBtn.disabled = false;
        generatingText.style.display = "none";
      }
    }
  </script>
</body>
</html>